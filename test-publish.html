<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Publish - SMPIT DTI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0A3D73 0%, #1E9E44 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .btn {
            background: #0A3D73;
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 1rem;
        }
        .btn:hover {
            background: #082b52;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test Publish Berita ke GitHub</h1>
        <p>Halaman ini untuk testing publish berita langsung ke GitHub repository.</p>
        
        <form id="newsForm">
            <div class="form-group">
                <label>Judul Berita *</label>
                <input type="text" id="title" required value="Test Berita Otomatis">
            </div>
            
            <div class="form-group">
                <label>Kategori</label>
                <select id="category">
                    <option value="Pengumuman">Pengumuman</option>
                    <option value="Kegiatan">Kegiatan</option>
                    <option value="Prestasi">Prestasi</option>
                    <option value="Umum">Umum</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Tanggal</label>
                <input type="date" id="date" required>
            </div>
            
            <div class="form-group">
                <label>Isi Berita *</label>
                <textarea id="content" required>Ini adalah test berita yang dipublish secara otomatis melalui GitHub API.</textarea>
            </div>
            
            <div class="form-group">
                <label>GitHub Token *</label>
                <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" required>
                <small>Masukkan GitHub Personal Access Token dengan scope repo</small>
            </div>
            
            <div class="form-group">
                <label>Username GitHub *</label>
                <input type="text" id="username" value="SMPITdaaruttarbiyah" required>
            </div>
            
            <div class="form-group">
                <label>Repository *</label>
                <input type="text" id="repo" value="smpit-dti-web" required>
            </div>
            
            <button type="submit" class="btn" id="publishBtn">
                üöÄ Publish ke GitHub
            </button>
            <button type="button" class="btn" onclick="clearLog()">
                üóëÔ∏è Clear Log
            </button>
        </form>
        
        <div id="status" class="status" style="display: none;"></div>
        <div id="log" class="log"></div>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        const publishBtn = document.getElementById('publishBtn');
        
        // Set today's date
        document.getElementById('date').valueAsDate = new Date();
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
        
        function clearLog() {
            logDiv.textContent = '';
            statusDiv.style.display = 'none';
        }
        
        // Base64 encoding for GitHub API
        function base64Encode(str) {
            const utf8Bytes = new TextEncoder().encode(str);
            let binaryString = '';
            utf8Bytes.forEach(byte => {
                binaryString += String.fromCharCode(byte);
            });
            return btoa(binaryString);
        }
        
        async function publishToGitHub(newsData, token, username, repo) {
            log('üîÑ Starting GitHub API call...');
            
            try {
                // First, try to get existing file
                const getFileUrl = `https://api.github.com/repos/${username}/${repo}/contents/assets/data/news.json`;
                log(`üì• Getting existing file from: ${getFileUrl}`);
                
                let fileSha = null;
                let existingNews = [];
                
                try {
                    const getResponse = await fetch(getFileUrl, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        fileSha = fileData.sha;
                        const content = atob(fileData.content.replace(/\s/g, ''));
                        existingNews = JSON.parse(content).news || [];
                        log(`‚úÖ Found existing file with ${existingNews.length} news items`);
                    } else if (getResponse.status === 404) {
                        log('üìù File not found, will create new one');
                    } else {
                        throw new Error(`Failed to get file: ${getResponse.status}`);
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è Error getting file: ${error.message}`);
                }
                
                // Add new news to the beginning
                existingNews.unshift(newsData);
                
                // Prepare new file content
                const newContent = {
                    version: "2.0.0",
                    lastUpdated: new Date().toISOString(),
                    website: "SMPIT DAARUT TARBIYAH INDONESIA",
                    totalNews: existingNews.length,
                    news: existingNews,
                    metadata: {
                        updatedAt: new Date().toISOString(),
                        updatedBy: "Test Publish Script"
                    }
                };
                
                const jsonString = JSON.stringify(newContent, null, 2);
                const encodedContent = base64Encode(jsonString);
                
                // Update/create file
                const updateUrl = `https://api.github.com/repos/${username}/${repo}/contents/assets/data/news.json`;
                const body = {
                    message: `Add news: ${newsData.title}`,
                    content: encodedContent,
                    branch: 'main'
                };
                
                if (fileSha) {
                    body.sha = fileSha;
                }
                
                log(`üì§ Uploading to GitHub: ${updateUrl}`);
                
                const updateResponse = await fetch(updateUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (updateResponse.ok) {
                    const result = await updateResponse.json();
                    log(`‚úÖ Successfully published to GitHub!`);
                    log(`üìù Commit SHA: ${result.commit.sha}`);
                    log(`üåê File URL: ${result.content.html_url}`);
                    return { success: true, result };
                } else {
                    const error = await updateResponse.json();
                    throw new Error(`GitHub API Error: ${error.message}`);
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                throw error;
            }
        }
        
        // Form submission
        document.getElementById('newsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            clearLog();
            log('üöÄ Starting publish process...');
            
            const formData = {
                title: document.getElementById('title').value.trim(),
                category: document.getElementById('category').value,
                date: document.getElementById('date').value,
                content: document.getElementById('content').value.trim(),
                token: document.getElementById('token').value.trim(),
                username: document.getElementById('username').value.trim(),
                repo: document.getElementById('repo').value.trim()
            };
            
            // Validation
            if (!formData.title || !formData.content) {
                showStatus('Judul dan konten harus diisi!', 'error');
                return;
            }
            
            if (!formData.token || !formData.token.startsWith('ghp_')) {
                showStatus('GitHub token tidak valid! Harus dimulai dengan ghp_', 'error');
                return;
            }
            
            if (!formData.username || !formData.repo) {
                showStatus('Username dan repository harus diisi!', 'error');
                return;
            }
            
            publishBtn.disabled = true;
            publishBtn.textContent = 'üîÑ Publishing...';
            showStatus('Sedang mempublish ke GitHub...', 'info');
            
            try {
                const newsData = {
                    id: Date.now().toString(),
                    title: formData.title,
                    category: formData.category,
                    date: formData.date,
                    content: formData.content,
                    image: "",
                    published: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                log(`üì∞ News data: ${JSON.stringify(newsData, null, 2)}`);
                
                const result = await publishToGitHub(newsData, formData.token, formData.username, formData.repo);
                
                if (result.success) {
                    showStatus(`‚úÖ Berita "${formData.title}" berhasil dipublish ke GitHub!`, 'success');
                    log(`üéâ Success! Check your website: https://${formData.username}.github.io/${formData.repo}/`);
                    
                    // Reset form
                    document.getElementById('newsForm').reset();
                    document.getElementById('date').valueAsDate = new Date();
                }
                
            } catch (error) {
                showStatus(`‚ùå Gagal publish: ${error.message}`, 'error');
                log(`üí• Full error: ${error.stack}`);
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = 'üöÄ Publish ke GitHub';
            }
        });
        
        log('üöÄ Test Publish Script Ready!');
        log('üìù Fill in the form and click "Publish ke GitHub"');
    </script>
</body>
</html>